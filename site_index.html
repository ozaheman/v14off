
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Urban Axis - Project Dashboard</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/print.css" media="print">
    
    <!-- 3D Dependencies (Three.js) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
<!-- HDR Environment Loader -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/RGBELoader.js"></script>
    <style>/* HIDE MAIN CONTENT INITIALLY */
        #main-site-container { max-width: 1600px; margin: auto; padding: 20px; display: none; } 
        
        .site-main-layout { display: flex; gap: 20px; }
        .site-project-list { flex: 1; }
        .site-project-details { flex: 3; background: #f9f9f9; padding: 15px; border-radius: 8px; }
        .site-project-details h3 { margin-top: 0; }
        .gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; margin-top: 15px; }
        .thumbnail-container { position: relative; border: 1px solid #ccc; padding: 5px; border-radius: 5px; background: #fff; text-align: center; cursor: pointer; }
        .thumbnail-container.read-only .thumbnail-delete-btn { display: none; }
        .thumbnail-container.read-only { cursor: default; }
        .thumbnail-delete-btn { position: absolute; top: -8px; right: -8px; background: #dc3545; color: white; border: 2px solid white; border-radius: 50%; width: 24px; height: 24px; text-align: center; line-height: 21px; cursor: pointer; font-weight: bold; z-index: 10; box-shadow: 0 1px 3px rgba(0,0,0,0.3); }
        .thumbnail { width: 100%; height: 110px; object-fit: cover; border: 1px solid #eee; }
        .thumbnail-caption { font-size: 0.8em; word-wrap: break-word; }
        .file-icon { font-size: 2em; font-weight: bold; color: #666; display: flex; align-items: center; justify-content: center; height: 110px; background-color: #f0f0f0; }
        /* FIX [2, 11]: Doc Expiry Badge Styles */
        .expiry-badge { position: absolute; bottom: 5px; left: 5px; right: 5px; font-size: 0.7em; padding: 2px; border-radius: 3px; color: white; text-align: center; }
        .expiry-badge.expired { background-color: #dc3545; }
        .expiry-badge.soon { background-color: #fd7e14; }
        .expiry-badge.active { background-color: #28a745; }

        .modal-body { max-height: 80vh; overflow-y: auto; background-color: #fff; padding: 20px; }
        .form-buttons-container { display: flex; flex-wrap: wrap; gap: 10px; }
        .form-buttons-container .form-btn { flex: 1 1 200px; }
          /* Gantt & BIM Styles */
        #boq-table, .mom-table { width: 100%; border-collapse: collapse; font-size: 0.8em; }
        .mom-table textarea {
        width: 98%;
        border: 1px solid #ddd;
        padding: 4px;
        border-radius: 4px;
        resize: vertical;
        min-height: 50px;
        font-family: inherit;
        font-size: 0.9em;
        white-space: pre-wrap; /* Ensures text wraps */
    }
    
    .input-row-container {
        display: flex; 
        gap: 15px; 
        margin-bottom: 10px;
    }
        #boq-table th, #boq-table td, .mom-table th, .mom-table td, .output-table th, .output-table td { border: 1px solid #ccc; padding: 6px; text-align: left; }
        #boq-table th, .mom-table th, .output-table th { background-color: #f2f2f2; }
        #boq-table td[contenteditable="true"] { background-color: #fff9e6; }, #long-lead-table td[contenteditable="true"] { background-color: #fff9e6; }
        #boq-totals { margin-top: 15px; padding: 10px; background: #e9ecef; border-radius: 5px; text-align: right; }
        .progress-bar-container { background: #e9ecef; border-radius: 5px; overflow: hidden; }
        .progress-bar { background-color: var(--primary-color); height: 24px; color: white; display: flex; align-items: center; justify-content: center; font-size: 0.9em; transition: width 0.4s ease; }
        /* Calendar Styles */
        /* NEW: Styles for File Preview Modal */
        /*
        #file-preview-modal .modal-content {
            width: 90%;
            max-width: 1000px;
        }
        #file-preview-modal .modal-body {
            text-align: center;
        }
        #file-preview-image {
            max-width: 100%;
            max-height: 70vh;
            margin-bottom: 15px;
        }
        #file-preview-info {
            font-style: italic;
            color: #666;
            margin-bottom: 15px;
        }
        /*
        #file-preview-modal .modal-content { width: 90%; max-width: 1000px; }
        #file-preview-modal .modal-body { text-align: center; }
        #file-preview-image { max-width: 100%; max-height: 70vh; margin-bottom: 15px; }
        #file-preview-embed { width: 100%; height: 70vh; border: 1px solid #ccc; }
        #file-preview-info { font-style: italic; color: #666; margin-bottom: 15px; }*/
        
        .calendar-header { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; padding: 10px; background: #f0f0f0; border-bottom: 1px solid #ddd; gap: 10px;}
        .calendar-header h4 { margin: 0; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background-color: #ddd; }
        .calendar-day-header { text-align: center; font-weight: bold; padding: 8px; background-color: #f9f9f9; font-size: 0.8em; }
         .calendar-day { 
            background-color: #fff; 
            min-height: 120px; /* Increased min-height slightly */
            padding: 5px; 
            font-size: 0.8em; 
            position: relative; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; /* Prevent content from spilling out */
        }
        .calendar-day.other-month { background-color: #f5f5f5; color: #aaa; }
        .day-number { font-weight: bold; flex-shrink: 0; /* Prevent the day number from shrinking */ }
        .day-events { 
            margin-top: 5px; 
            display: flex; 
            flex-direction: column; 
            gap: 3px; 
            flex: 1; /* Allow this container to grow and fill available space */
            overflow-y: auto; /* Add a scrollbar if events overflow */
        }
         .event-dot, .event-bar { display: block; padding: 2px 5px; border-radius: 3px; color: white; font-size: 0.9em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex-shrink: 0; }
        .event-dot.leave { background-color: #6f42c1; cursor: help; } 
        .event-bar.gantt-task { background-color: #6c757d; cursor: help; }
       
        .event-dot, .event-bar { display: block; padding: 2px 5px; border-radius: 3px; color: white; font-size: 0.9em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .event-dot.mom { background-color: #007bff; }
        .event-dot.status { background-color: #28a745; cursor: help; }
        .event-dot.noc { background-color: #6f42c1; }
        .event-dot.holiday { background-color: #fd7e14; cursor: help; } 
        .event-bar.gantt-task { background-color: #6c757d; cursor: help; }
        .clickable-event { cursor: pointer !important; text-decoration: underline; }
        }
        #bim-viewer-container {
    flex: 1; /* BIM viewer takes available space */
    background: #222;
    position: relative;
    min-height: 200px; /* Minimum height for BIM viewer */
    border-radius: 4px;
    
    z-index: 1;
}
#bim-tooltip {
    position: absolute;
    top: 10px;
    left: 10px;
    background: rgba(0,0,0,0.8);
    color: white;
    padding: 10px;
    border-radius: 5px;
    display: none;
    pointer-events: none; /* Prevents it from interfering with mouse events on the canvas */
    z-index: 100; 
    max-width: 250px;
    font-size: 0.9em;
}
#bim-tooltip small {
    color: #ccc;
}
         /* Simulation Controls */
       
          .sim-controls, .sim-controls1 { background: #eee; padding: 10px; margin-bottom: 10px; border-radius: 5px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;}
        .floor-selector, .floor-selector1 { display: flex; gap: 5px; margin-left: auto; }
        .floor-btn, .floor-btn1 { padding: 5px 10px; font-size: 0.8em; background: #ddd; border: none; border-radius: 3px; cursor: pointer; }
        .floor-btn.active, .floor-btn1.active { background: var(--primary-color); color: white; }
        
        /* Ensure Login Modal is visible */
        #login-modal { display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 99999; justify-content: center; align-items: center; }
        #resource-calculator-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        #resource-calculator-table th, #resource-calculator-table td { border: 1px solid #ccc; padding: 6px; }
        #resource-calculator-table input { width: 80px; text-align: right; border: 1px solid #ddd; padding: 4px; border-radius: 4px; }
        .resource-total-row { font-weight: bold; background-color: #f2f2f2; }
        .mom-table input { width: 98%; border: 1px solid #ddd; padding: 4px; border-radius: 4px; }
        .mom-history-list { list-style: none; padding: 0; }
        .mom-list-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 5px; border-bottom: 1px solid #eee; }
        .mom-list-item:last-child { border-bottom: none; }
        .mom-list-info { flex-grow: 1; margin-right: 15px; }
        .mom-list-info small { color: #666; font-style: italic; }
        
        
        .welcome-message { color: #666; margin-right: 15px; font-weight: bold; font-size: 0.95em; }
        /* NEW: Active Tasks List Style */
        #active-tasks-list {
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 10px;
            margin-top: 10px;
            font-size: 0.9em;
            min-height: 40px;
            max-height: 150px;
            overflow-y: auto;
            width: 100%;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
        }
        #active-tasks-list h5 { margin: 0 0 5px 0; color: #666; font-size: 0.85em; text-transform: uppercase; }
        #active-tasks-list ul { margin: 0; padding-left: 20px; }
        #active-tasks-list li { margin-bottom: 2px; }
        #active-tasks-list li span.progress { color: #28a745; font-weight: bold; font-size: 0.8em; margin-left: 5px; }
        /* Ensure Login Modal is visible regardless of container state */
        #login-modal { 
            display: flex; 
            position: fixed; 
            top: 0; left: 0; 
            width: 100%; height: 100%; 
            background: rgba(0,0,0,0.8); 
            z-index: 99999; 
            justify-content: center; 
            align-items: center; 
        }
        #login-modal[style*="display: none"] .modal-content { display: none; }

        /* Logout Button Style */
        #logout-btn {
            background-color: #dc3545;
            margin-left: 10px;
            display: none; /* Hidden by default */
        }
        #logout-btn:hover {
            background-color: #c82333;
        }
         /* Add this to your style block */
    .stat-card {
        background: white; border: 1px solid #ddd; border-radius: 8px; padding: 15px; flex: 1; min-width: 140px;
        text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .stat-card h3 { font-size: 0.85em; color: #666; margin: 0 0 5px 0; text-transform: uppercase; }
    .stat-card span { font-size: 1.5em; font-weight: bold; color: var(--primary-color); }
    
    /* Approval Button Colors */
    .btn-approved { background-color: #28a745 !important; color: white; }
    .btn-approved-noted { background-color: #fd7e14 !important; color: white; }
    .btn-revise { background-color: #007bff !important; color: white; }
    .btn-rejected { background-color: #6c757d !important; color: white; }
    .btn-pending { background-color: #dc3545 !important; color: white; } /* Red for pending action */
    
    .detailed-log-item { border: 1px solid #ccc; border-radius: 5px; margin-bottom: 15px; background: #fff; overflow: hidden; }
    .log-header { background: #f1f1f1; padding: 10px; font-weight: bold; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; }
    .log-body { padding: 15px; }
    .approval-grid { display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap; }
    .tab-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px; }
    /* FIX [11]: Styles for File Preview Modal */
    #file-preview-modal .modal-content { width: 90%; max-width: 1000px; }
    #file-preview-modal .modal-body { text-align: center; }
    #file-preview-image { max-width: 100%; max-height: 70vh; margin-bottom: 15px; }
    #file-preview-embed { width: 100%; height: 70vh; border: 1px solid #ccc; }
    #file-preview-info { font-style: italic; color: #666; margin-bottom: 15px; }
    
    /* BIM VIEWER FIX: Wrapper for Gantt and BIM */
    .schedule-bim-wrapper {
        display: flex;
        gap: 15px;
        height: 600px; /* Crucial for giving children a height context */
        margin-top: 15px;
    }
    .tab-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        flex-wrap: wrap;
        gap: 10px;
    }
    .tab-controls .search-input {
        max-width: 250px;
    }
    /* NEW: Styles for Info Modules */
    .info-module-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
    }
    .info-module-grid .input-group {
        margin-bottom: 0;
    }
    .logo-preview-container {
        display: flex;
        gap: 15px;
        align-items: center;
        margin-top: 10px;
    }
    .logo-preview {
        max-width: 150px;
        max-height: 75px;
        border: 1px solid #ddd;
        padding: 5px;
        background: #fff;
    }
    </style>
</head>
<body>

<div id="login-modal" class="modal-overlay">
    <div class="modal-content" style="width: 400px; text-align: center;">
        <h2>Project Dashboard Login</h2>
        <div class="input-group">
            <select id="login-role">
                <option value="site">Site Engineer</option> <option value="arch">Architect (Arch)</option> <option value="str">Structural (STR)</option> <option value="mep">MEP Engineer</option> <option value="pm">Project Manager</option> <option value="contractor">Contractor</option> <option value="client">Client</option> <option value="viewer">Viewer</option> <option value="admin">Admin</option>
            </select>
        </div>
        <div class="input-group">
            <input type="text" id="login-username" placeholder="Username">
        </div>
        <div class="input-group">
            <input type="password" id="login-password" placeholder="Password">
        </div>
        <p id="login-error" style="color: red; display: none;">Invalid credentials.</p>
        <button id="perform-login-btn" class="primary-button" style="width: 100%;">Login</button>
    </div>
</div>

<div id="main-site-container"> 
    <header class="app-header">
        <h1 id="dashboard-title">Site Dashboard</h1>
        <div class="dashboard-header-controls">
            <span id="welcome-user-msg" class="welcome-message"></span>
            <button id="logout-btn" class="primary-button">Logout</button>
            <button id="load-data-btn" class="secondary-button">Load Project File</button>
            <button id="save-data-btn">Save & Share Updates</button>
        </div>
    </header>

    <!-- REPLACEMENT (COMPLETE) STATS SECTION -->
<div id="project-dashboard-stats" class="dashboard-stats-container" style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
    <div class="stat-card">
        <h3>Pending RFIs</h3>
        <span id="stat-rfi-pending">0</span>
    </div>
    <div class="stat-card">
        <h3>Pending Materials</h3>
        <span id="stat-mat-pending">0</span>
    </div>
    <div class="stat-card">
        <h3>Work Done</h3>
        <span id="stat-work-progress">0%</span>
    </div>
    <div class="stat-card">
        <h3>Tasks Completed</h3>
        <span id="stat-tasks-comp">0</span>
    </div>
    <div class="stat-card">
        <h3>Bulletins</h3>
        <span id="stat-bulletins">0</span>
    </div>
    
    <div class="stat-card">
        <h3>Project Age</h3>
        <span id="stat-days-active">0 Days</span>
    </div>
      <div class="stat-card">
        <h3>Expiring Docs</h3>
        <span id="stat-expiry">0</span>
    </div>
    <!-- NEW: WELCOME MESSAGE CARD -->
    <div id="welcome-message-card" class="stat-card" style="flex: 2 1 350px; text-align: left; display: none; flex-direction: column; justify-content: center; background: #f4f7fc; border-left: 5px solid var(--primary-color);">
        <h4 id="welcome-greeting" style="margin: 0 0 8px 0; font-size: 1.1em; color: var(--primary-color);"></h4>
        <div id="welcome-quote" style="font-size: 0.85em; font-style: italic; margin-bottom: 8px; line-height: 1.3; max-height: 60px; overflow: hidden;">
            <span id="welcome-quote-text"></span>
            <strong id="welcome-quote-author" style="display: block; text-align: right; padding-right: 10px;"></strong>
        </div>
        <div id="welcome-fact-container" style="font-size: 0.85em; line-height: 1.3; max-height: 50px; overflow: hidden;">
            <strong>Did you know?</strong> <span id="welcome-fact-text"></span>
        </div>
    </div>
</div>

    <div class="site-main-layout">
        <div class="site-project-list">
            <h2>Projects</h2>
            <table id="project-list-table">
                <thead><tr><th>Job No</th><th>Project / Client</th><th>Plot No</th><th>Status / Progress</th></tr></thead>
                <tbody id="project-list-body"></tbody>
            </table>
        </div>

        <div id="project-details-view" class="site-project-details">
            <button id="back-to-global-btn" class="secondary-button" style="display: none; margin-bottom: 10px;">← All Projects Overview</button>
            <h3 id="details-project-name">Select a Project</h3>
            <p id="details-project-info"></p>
            <hr>
            
            <div id="control-tabs-container" class="tabs control-tabs">
                <button class="tab-button active" data-tab="status">Status & Photos</button>
                <button class="tab-button" data-tab="client-info">Client Info</button>
                <button class="tab-button" data-tab="contractor-info">Contractor Info</button>
                <button class="tab-button" data-tab="project-docs">Project Docs</button>
                 <button class="tab-button" data-tab="tender-docs">Tender Docs</button>
                  <button class="tab-button" data-tab="vendor-lists">Vendor Lists</button>
                <button class="tab-button" data-tab="site-docs">Site Docs & MoM</button>
                <button class="tab-button" data-tab="boq">BOQ</button>
                <button class="tab-button" data-tab="schedule">Schedule & BIM</button>
                <button class="tab-button" data-tab="calendar">Calendar</button>
                <button class="tab-button" data-tab="rfi">RFI Log</button>
                <button class="tab-button" data-tab="materials">Materials</button>
                <!-- FIX [4]: Add NOC Tab Button -->
                <button class="tab-button" data-tab="noc">NOC Tracker</button>
                
                <button class="tab-button" data-tab="subcontractors">Subcontractors</button>
                <!-- ADDED: Long Lead Tab -->
                <button class="tab-button" data-tab="long-lead">Long Lead Items</button>
                <!-- ADDED: NOC/Project Uploads Tab -->
                <button class="tab-button" data-tab="project-uploads">Project Uploads</button>
                <button class="tab-button" data-tab="bulletin">Bulletin</button>
                <!-- New Client & Designer Tabs -->
                <button class="tab-button" data-tab="snag-list">Snag List</button>
                <button class="tab-button" data-tab="payment-list">Payments</button>
                <button class="tab-button" data-tab="inventory">Inventory</button>
                <button class="tab-button" data-tab="budget">Budget</button>
                <button class="tab-button" data-tab="bim-designer">BIM Designer</button>
                <button class="tab-button" data-tab="tools">Tools</button>
                <button class="tab-button" data-tab="forms">Forms</button>
            </div>

            <!-- TAB CONTENT PANELS -->
            <div id="status-tab" class="tab-content active">
                <h4>Update Site Status</h4>
                <div class="input-group"><select id="site-status-select"><option>Pending Start</option><option>Mobilization</option><option>Shoring & Excavation</option><option>Sub-Structure</option><option>Super-Structure</option><option>Finishing</option><option>Handover</option><option>Completed</option></select></div>
                <h4>Upload Site Photos</h4>
                <div class="input-group"><input type="file" id="photo-upload-input" accept="image/*" multiple></div>
                <hr>
                <div class="tab-controls">
                    <h4>Photo Gallery</h4>
                    <input type="text" id="photo-search-input" class="search-input" placeholder="Search photos by name...">
                </div>
                <div id="photo-gallery" class="gallery-grid"></div>
            </div>
<!-- NEW: Client Info Tab -->
            <div id="client-info-tab" class="tab-content">
                <h4>Client Information</h4>
                <p>Manage detailed client information for this project.</p>
                <div class="info-module-grid">
                    <div class="input-group"><label>Company Name</label><input type="text" id="client-info-name"></div>
                    <div class="input-group"><label>Contact Person</label><input type="text" id="client-info-contact-person"></div>
                    <div class="input-group"><label>Mobile</label><input type="tel" id="client-info-mobile"></div>
                    <div class="input-group"><label>Phone 1</label><input type="tel" id="client-info-phone1"></div>
                    <div class="input-group"><label>Phone 2</label><input type="tel" id="client-info-phone2"></div>
                    <div class="input-group"><label>Email 1</label><input type="email" id="client-info-email1"></div>
                    <div class="input-group"><label>Email 2</label><input type="email" id="client-info-email2"></div>
                    <div class="input-group"><label>Fax</label><input type="text" id="client-info-fax"></div>
                    <div class="input-group"><label>Website</label><input type="url" id="client-info-website"></div>
                    <div class="input-group"><label>Location Map URL</label><input type="url" id="client-info-map"></div>
                </div>
                <div class="input-group"><label>Address</label><textarea id="client-info-address" rows="3"></textarea></div>
                <hr>
                <div class="info-module-grid">
                     <div>
                        <label>Logo 1 (e.g., Main Logo)</label><input type="file" id="client-info-logo1-input" accept="image/*">
                        <div class="logo-preview-container"><img id="client-info-logo1-preview" src="" class="logo-preview" alt="Logo 1 Preview"></div>
                    </div>
                    <div>
                        <label>Logo 2 (e.g., Letterhead Logo)</label><input type="file" id="client-info-logo2-input" accept="image/*">
                        <div class="logo-preview-container"><img id="client-info-logo2-preview" src="" class="logo-preview" alt="Logo 2 Preview"></div>
                    </div>
                </div>
                <hr>
                <button id="save-client-info-btn" class="primary-button">Save Client Info</button>
            </div>

            <!-- NEW: Contractor Info Tab -->
            <div id="contractor-info-tab" class="tab-content">
                <h4>Main Contractor Information</h4>
                <p>Manage detailed contractor information for this project.</p>
                <div class="info-module-grid">
                    <div class="input-group"><label>Company Name</label><input type="text" id="contractor-info-name"></div>
                    <div class="input-group"><label>Contact Person</label><input type="text" id="contractor-info-contact-person"></div>
                    <div class="input-group"><label>Mobile</label><input type="tel" id="contractor-info-mobile"></div>
                    <div class="input-group"><label>Phone 1</label><input type="tel" id="contractor-info-phone1"></div>
                    <div class="input-group"><label>Phone 2</label><input type="tel" id="contractor-info-phone2"></div>
                    <div class="input-group"><label>Email 1</label><input type="email" id="contractor-info-email1"></div>
                    <div class="input-group"><label>Email 2</label><input type="email" id="contractor-info-email2"></div>
                    <div class="input-group"><label>Fax</label><input type="text" id="contractor-info-fax"></div>
                    <div class="input-group"><label>Website</label><input type="url" id="contractor-info-website"></div>
                    <div class="input-group"><label>Location Map URL</label><input type="url" id="contractor-info-map"></div>
                </div>
                <div class="input-group"><label>Address</label><textarea id="contractor-info-address" rows="3"></textarea></div>
                <hr>
                 <div class="info-module-grid">
                     <div>
                        <label>Logo 1 (e.g., Main Logo)</label><input type="file" id="contractor-info-logo1-input" accept="image/*">
                        <div class="logo-preview-container"><img id="contractor-info-logo1-preview" src="" class="logo-preview" alt="Logo 1 Preview"></div>
                    </div>
                    <div>
                        <label>Logo 2 (e.g., Letterhead Logo)</label><input type="file" id="contractor-info-logo2-input" accept="image/*">
                        <div class="logo-preview-container"><img id="contractor-info-logo2-preview" src="" class="logo-preview" alt="Logo 2 Preview"></div>
                    </div>
                </div>
                <hr>
                <button id="save-contractor-info-btn" class="primary-button">Save Contractor Info</button>
            </div>
            <div id="project-docs-tab" class="tab-content"><h4>Project Documents (Read-Only)</h4>
                <div id="project-docs-gallery" class="gallery-grid"></div>
            </div>
               <div id="tender-docs-tab" class="tab-content">
                <h4>Tender Documents(Read-Only)</h4>
                <div id="tender-docs-gallery" class="gallery-grid"></div>
            </div>

            <div id="vendor-lists-tab" class="tab-content">
                <div class="tab-controls">
                    <h4>Project Vendor Management</h4>
                    <button id="report-btn-vendor-management" data-module="vendor-management" class="secondary-button">Generate Report</button>
                </div>
                <p>Assign approved vendors from the master list to this project.</p>
                <hr>
                <h5>Assigned Vendors for this Project</h5>
                <table class="mom-table">
                    <thead><tr><th>Category</th><th>Item</th><th>Manufacturer</th><th>Action</th></tr></thead>
                    <tbody id="project-vendor-list-body"></tbody>
                </table>
                <hr>
                <h5>Add Vendor from Master List</h5>
                <div class="input-group" style="margin-bottom: 10px;">
                    <input type="text" id="vendor-master-search" placeholder="Search Master List by Item, Manufacturer, etc...">
                </div>
                <div style="max-height: 300px; overflow-y: auto;">
                    <table class="mom-table">
                        <thead><tr><th>Category</th><th>Item</th><th>Manufacturer</th><th>Action</th></tr></thead>
                        <tbody id="vendor-search-results-body"></tbody>
                    </table>
                </div>
                <hr>
                <h4>Vendor & Subcontractor Lists (Read-Only)</h4>
                <div id="vendor-lists-gallery" class="gallery-grid"></div>
            </div>

            <div id="site-docs-tab" class="tab-content">
                <h4>Upload Site Documents</h4>
                <div class="input-group-grid" style="grid-template-columns: 2fr 1fr 1fr; gap: 10px; align-items: end;">
                    <input type="text" id="doc-name-input" placeholder="Document Name/Description">
                    <div><label style="font-size:0.8em; margin-bottom:2px; display:block;">Expiry Date (Optional)</label><input type="date" id="doc-expiry-date"></div>
                    <input type="file" id="doc-upload-input" multiple>
                </div>
                <div id="site-doc-gallery" class="gallery-grid"></div><hr>
                 <div class="tab-controls">
                    <h4>Minutes of Meeting (MoM)</h4>
                     <div><input type="text" id="mom-search-input" class="search-input" placeholder="Search MoM..."><button id="new-mom-btn" class="form-btn">New MoM</button><button data-module="mom" class="secondary-button report-btn">Report</button></div>
                </div>
                <div id="mom-list" class="mom-history-list"></div>
            </div>
            <div id="project-uploads-tab" class="tab-content">
                <h4>Project-Specific Document Uploads</h4>
                <p>Upload other key project documents not covered in other sections.</p>
                <div class="input-group-grid" style="grid-template-columns: 2fr 1fr auto; gap: 10px; align-items: end; background: #f0f0f0; padding: 10px; border-radius: 5px;">
                    <input type="text" id="proj-upload-doc-name-input" placeholder="Document Name/Description">
                    <div><label style="font-size:0.8em; margin-bottom:2px; display:block;">Expiry Date (Optional)</label><input type="date" id="proj-upload-expiry-date"></div>
                    <div><input type="file" id="proj-upload-file-input"><button id="proj-upload-btn" class="primary-button" style="width:100%; margin-top: 5px;">Upload</button></div>
                </div>
                <div id="project-uploads-gallery" class="gallery-grid" style="margin-top: 20px;"></div>
            </div>
            
            <div id="subcontractors-tab" class="tab-content">
               <div class="tab-controls">
                    <button id="add-subcontractor-btn" class="form-btn">+ Add Subcontractor</button>
                    <input type="text" id="subcontractor-search-input" class="search-input" placeholder="Search by Company, Trade...">
                </div>
                <div id="subcontractor-list" style="margin-top: 15px;display: grid; gap: 15px; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));"></div>
            </div>

            <div id="bulletin-tab" class="tab-content">
                <div class="tab-controls">
                    <h4>Site Bulletin</h4>
                    <button id="report-btn-bulletin" data-module="bulletin" class="secondary-button">Generate Report</button>
                </div>
                <p>View site-wide announcements and tasks.</p>
                <div style="border-bottom: 1px solid #ccc; padding-bottom: 15px; margin-bottom: 15px;">
                    <h5>New Bulletin / Task</h5>
                    <input type="text" id="bulletin-subject" placeholder="Subject"><textarea id="bulletin-details" rows="3" placeholder="Details..."></textarea><input type="text" id="bulletin-assigned-to" placeholder="Assigned To (Optional)"><button id="post-bulletin-btn" class="form-btn">Post</button>
                </div>
                <div id="bulletin-feed"></div>
            </div>
            
            

            <div id="rfi-tab" class="tab-content">
                <div class="tab-controls">
                    <button id="new-rfi-btn" class="form-btn">+ New RFI</button>
                    <input type="text" id="rfi-search-input" class="search-input" placeholder="Search by Ref, Subject...">
                    <button id="report-btn-rfi" data-module="rfi" class="secondary-button">Generate Report</button>
                </div>
                <div id="rfi-log-list" style="margin-top: 15px;"></div>
            </div> 

            <div id="long-lead-tab" class="tab-content">
                <div class="tab-controls">
                    <h4>Long Lead Items Tracker</h4>
                    <button id="report-btn-long-lead" data-module="long-lead" class="secondary-button">Generate Report</button>
                </div>
                <p>Monitor items with long procurement durations that impact the critical path.</p>
                <div style="max-height: 60vh; overflow-y: auto;"><table id="long-lead-table" class="mom-table">
                     <thead><tr><th>Item</th><th>Procurement (Days)</th><th>Procurement Start Date</th><th>Submittal Date</th><th>Approval Date</th><th>Delivery Date</th><th>Required On-Site</th><th>Source</th></tr></thead>
                    <tbody id="long-lead-table-body"><tr><td colspan="8">No long-lead items identified.</td></tr></tbody>
                </table></div>
                 <hr>
                <h4>Add Manual Long Lead Item</h4>
                <div class="input-group-grid" style="grid-template-columns: 2fr 1fr 1fr auto; gap: 10px; align-items: end; background: #f0f0f0; padding: 10px; border-radius: 5px;">
                    <input type="text" id="ll-new-name" placeholder="Item Name (e.g., Special Order Marble)">
                    <input type="number" id="ll-new-days" value="90" placeholder="Procurement Days">
                    <div><label style="font-size:0.8em; margin-bottom:2px; display:block;">Required On-Site Date</label><input type="date" id="ll-new-required"></div>
                    <button id="ll-add-btn" class="primary-button">Add Item</button>
                </div>
            </div>

            <div id="materials-tab" class="tab-content">
                <div class="tab-controls">
                    <button id="new-material-submittal-btn" class="form-btn">+ New Material Submittal</button>
                    <input type="text" id="materials-search-input" class="search-input" placeholder="Search by Ref, Item name...">
                    <button id="report-btn-materials" data-module="materials" class="secondary-button">Generate Report</button>
                </div>
                <div id="material-approval-list" style="margin-top: 15px;"></div>
            </div>

            <div id="boq-tab" class="tab-content">
                <div class="tab-controls" style="margin-bottom: 0;">
                    <input type="text" id="boq-search-input" class="search-input" placeholder="Search Description...">
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="file" id="boq-import-input" accept=".csv" style="display:none;">
                        <button id="boq-import-btn" class="secondary-button" onclick="document.getElementById('boq-import-input').click()">Import</button>
                        <button id="boq-export-btn" class="secondary-button">Export</button>
                        <button id="add-boq-item-btn" class="secondary-button">+ Add Item</button>
                       <button id="report-btn-boq" data-module="boq" class="secondary-button">Generate Report</button>
                    </div>
                </div>
                <!-- FIX: REMOVED DUPLICATE SNAG LIST CONTAINER -->
                  <div id="boq-actions-container" style="margin: 15px 0; border-top: 1px solid #ddd; padding-top: 15px;">
                    <!-- Buttons will be dynamically inserted here by boq_module.js -->
                </div>
                  <!-- MODIFIED TOTALS SECTION -->
                <div id="boq-totals">
                    <p>Previous Certified Value: <strong id="boq-previous-value">0.00 AED</strong></p>
                    <p>Value for Current Certificate: <strong id="boq-current-value">0.00 AED</strong></p>
                    <hr style="margin: 10px 0;">
                    <p>Total Contract Value: <strong id="boq-total-value">0.00 AED</strong></p>
                    <p>Total Work Done: <strong id="boq-work-done-value">0.00 AED</strong></p>
                    <h4>Overall Progress: <span id="boq-progress-percentage">0%</span></h4>
                    <div class="progress-bar-container"><div id="boq-progress-bar" class="progress-bar">0%</div></div>
                </div>
                <div style="max-height: 50vh; overflow-y: auto; margin-top: 10px;"><table id="boq-table"><thead><tr><th>ID</th><th>Description</th><th>Unit</th><th>Qty</th><th>Rate</th><th>Amount</th><th>Prev %</th><th>Current %</th><th>Total %</th><th>Work Done</th><th>Del</th></tr></thead><tbody id="boq-table-body"></tbody></table></div>
            </div>
            
            <div id="schedule-tab" class="tab-content" style="overflow-x: auto;">
                <div class="tab-controls">
                    <h3>Project Construction Schedule & BIM Simulation</h3>
                    <div style="display: flex; align-items: center; gap: 5px;">
                        <select id="schedule-page-size">
                            <option value="A4_portrait">A4 Portrait</option>
                            <option value="A4_landscape">A4 Landscape</option>
                            <option value="A3_portrait">A3 Portrait</option>
                            <option value="A3_landscape" selected>A3 Landscape</option>
                        </select>
                        <button id="print-schedule-btn" class="secondary-button">Generate PDF</button>
                    </div>
                </div>
                   <div class="sim-controls">
                   <div>
                    <button id="play-simulation-btn" class="primary-button">▶ Play</button>
                     <button id="goto-current-date-btn" class="primary-button">Current Date</button>
                    </div>
                    <input type="range" id="simulation-slider" min="0" max="100" value="0" style="flex-grow: 1;">
                    <span id="simulation-date-display" style="font-weight: bold; width: 200px; text-align: center;">-</span>
                </div>
                <button id="add-custom-task-btn" class="secondary-button small-button" style="margin-bottom: 10px;">+ Add New Task</button>
                <div class="floor-selector" id="floor-selector-container"></div>
                <div style="display:flex; flex-direction:column; gap:20px;">
                    <div id="villa-schedule-preview1" class="document-preview" style="border: 1px solid #ccc; height: 600px; overflow-y:auto; overflow-x:scroll;">
                        <p style="padding: 20px;">Select a project to load the schedule.</p>
                    </div>
                    <div id="bim-viewer-container" style="border:1px solid #ccc; height:600px; position:relative;">
                        <div id="bim-loading" style="color:white; position:absolute; top:50%; left:50%; transform:translate(-50%, -50%);"></div>
                        <div id="bim-tooltip" style="position:absolute; top:10px; left:10px; background:rgba(0,0,0,0.8); color:white; padding:10px; border-radius:5px; display:none; pointer-events:none; z-index:100; max-width:200px;">
                            <strong id="bim-item-name">Item Name</strong><br>
                            Status: <span id="bim-item-status">-</span><br>
                            Progress: <span id="bim-item-progress">0%</span>
                        </div>
                    </div>
                </div>
                 <div class="sim-controls1">
                 <div>
                    <button id="play-simulation-btn1" class="primary-button">▶ Play</button>
                     <button id="goto-current-date-btn1" class="primary-button">Current Date</button>
                     </div>
                    <input type="range" id="simulation-slider1" min="0" max="100" value="0" style="flex-grow: 1;">
                    <span id="simulation-date-display1" style="font-weight: bold; width: 200px; text-align: center;">-</span>
                </div>
              
                <div class="floor-selector1" id="floor-selector-container1"></div>
                <div id="active-tasks-list">
                    <h5>Current Activities</h5>
                    <ul><li style="color:#999;">No active tasks selected...</li></ul>
                </div>
                
                
            </div>
           
            <div id="calendar-tab" class="tab-content">
                <div class="calendar-header">
                    <div><button id="prev-month-btn" class="secondary-button">&lt;</button><button id="next-month-btn" class="secondary-button">&gt;</button></div>
                    <h4 id="month-year-display"></h4>
                    <div><select id="holiday-country-select"></select><button id="load-holidays-btn">Load Holidays</button></div>
                </div>
                 <div class="calendar-grid"><div class="calendar-day-header">Sun</div><div class="calendar-day-header">Mon</div><div class="calendar-day-header">Tue</div><div class="calendar-day-header">Wed</div><div class="calendar-day-header">Thu</div><div class="calendar-day-header">Fri</div><div class="calendar-day-header">Sat</div></div>
                <div id="calendar-grid-body" class="calendar-grid"></div>
            </div>

            <div id="tools-tab" class="tab-content">
                <h3>Project Management Tools</h3>
                <h4>Resource Calculator</h4>
                <div class="input-group" style="width: 200px;"><label>Average Man-Day Rate (AED)</label><input type="number" id="resource-day-rate" value="150" style="text-align: right;"></div>
                <div style="max-height: 60vh; overflow-y: auto; margin-top: 10px;">
                    <table id="resource-calculator-table">
                        <thead><tr><th>Task</th><th>Duration (Days)</th><th>Est. Man-Days</th><th>Est. Cost</th></tr></thead>
                        <tbody id="resource-calculator-body"></tbody>
                    </table>
                </div>
                <hr>
                <h4>Reporting</h4>
                <button id="generate-project-report-btn" class="form-btn">Generate Project Status Report</button>
                <hr>
                <h4>Approved Vendor/Supplier Search</h4>
                <div class="input-group">
                    <label for="vendor-search-input">Search for an item or manufacturer</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="vendor-search-input" placeholder="Enter item name or manufacturer..." style="flex-grow: 1;">
                        <button id="list-all-vendors-btn" class="secondary-button">List All</button>
                    </div>
                </div>
                <button id="add-new-vendor-btn" class="secondary-button small-button">+ Add New Vendor Entry</button>
                <div id="vendor-search-results" style="max-height: 40vh; overflow-y: auto;">
                    <p style="color:#888;">Enter a search term or click "List All" to find approved manufacturers.</p>
                </div>
                <hr>
                <!-- NEW: Image to Base64 Converter Tool -->
                <h4>Image to Base64 Converter</h4>
                <p>Upload an image to convert it into a Base64 data string. Useful for embedding logos or small images directly into code or documents.</p>
                <div class="input-group">
                    <label for="tool-image-input">Select Image File</label>
                    <input type="file" id="tool-image-input" accept="image/*">
                </div>
                <div id="tool-image-result-container" style="display: none; margin-top: 15px;">
                    <h5>Base64 String:</h5>
                    <textarea id="tool-base64-output" readonly rows="5"></textarea>
                    <h5>Preview from Base64:</h5>
                    <div style="border: 1px solid #ddd; padding: 5px; background: #fff; max-width: 300px;">
                        <img id="tool-base64-preview" src="" alt="Base64 Image Preview" style="max-width: 100%;">
                    </div>
                </div>
            </div>
            
            <div id="noc-tab" class="tab-content">
                <div class="tab-controls">
                     <h4>NOC & Permit Tracker</h4>
                     <div>
                        <input type="text" id="noc-search-input" class="search-input" placeholder="Search NOCs...">
                        <button id="report-btn-noc" data-module="noc" class="secondary-button">Generate Report</button>
                     </div>
                </div>
                <div class="input-group-grid" style="grid-template-columns: 1fr 1fr 1fr auto; gap: 10px; margin-bottom: 15px; background: #f0f0f0; padding: 10px; border-radius: 5px;">
                    <input type="text" id="noc-name" placeholder="NOC/Permit Name">
                    <input type="text" id="noc-authority" placeholder="Approving Authority (e.g., RTA)">
                    <input type="file" id="noc-file-upload">
                    <button id="add-noc-btn" class="primary-button">Add NOC</button>
                </div>
                <div id="noc-log-list"></div>
            </div>
            <div id="snag-list-tab" class="tab-content">
                <div class="tab-controls">
                    <h4>Snag List</h4>
                    <div><button id="new-snag-btn" class="primary-button">+ New Snag</button><button data-module="snag-list" class="secondary-button report-btn">Report</button></div>
                </div>
                <div id="snag-list-container"></div>
            </div>
            
            <div id="payment-list-tab" class="tab-content">
                <div class="tab-controls">
                    <h4>Payment Tracker</h4>
                    <div><button id="new-payment-btn" class="primary-button">+ Add Payment</button><button data-module="payment-list" class="secondary-button report-btn">Report</button></div>
                </div>
                <div id="payment-list-container"></div>
            </div>

            <div id="inventory-tab" class="tab-content">
                <div class="tab-controls">
                    <h4>Inventory & Warranty Tracker</h4>
                    <div><button id="new-inventory-item-btn" class="primary-button">+ Add Item</button><button data-module="inventory" class="secondary-button report-btn">Report</button></div>
                </div>
                <div id="inventory-list-container"></div>
            </div>

            <div id="budget-tab" class="tab-content">
                <div class="tab-controls">
                    <h4>Budget & Burnout Analysis</h4>
                    <button data-module="budget" class="secondary-button report-btn">Generate Report</button>
                </div>
                <div id="budget-summary-container"></div>
            </div>

            <div id="bim-designer-tab" class="tab-content">
                <h4>BIM Model Designer</h4>
                <p>Paste the content of a `generateStructure()` function below. This code will be saved per-project.</p>
                <textarea id="bim-code-area" spellcheck="false"></textarea>
                 <button id="load-default-bim-btn" class="secondary-button" style="margin-top:10px;">Load Default</button>
                <button id="save-bim-code-btn" class="primary-button" style="margin-top:10px;">Save & Apply</button>
            </div>
            <div id="forms-tab" class="tab-content">
                <h4>Available Forms</h4>
                <div class="form-buttons-container">
                   <button class="form-btn" data-form="pqs">Prequalification Submittal</button>
                    <button class="form-btn" data-form="shop_drawing_submittal">Shop Drawing Submittal</button>
                    <button class="form-btn" data-form="document_submittal">Document Submittal (DS)</button>
                    <button class="form-btn" data-form="material_submittal">Material Submittal (MS)</button>
                    <button class="form-btn" data-form="rfi">Request For Information (RFI)</button>
                    <button class="form-btn" data-form="cvi">Confirmation of Verbal Instruction</button>
                    <button class="form-btn" data-form="site_instruction">Site Instruction (SI)</button>
                    <button class="form-btn" data-form="ir_civil">IR - Civil/Structural</button>
                    <button class="form-btn" data-form="ir_arch">IR - Architectural</button>
                    <button class="form-btn" data-form="ir_fire">IR - Fire Protection</button>
                    <button class="form-btn" data-form="ir_electrical">IR - Electrical</button>
                    <button class="form-btn" data-form="ir_plumbing">IR - Plumbing</button>
                    <button class="form-btn" data-form="ir_hvac">IR - HVAC</button>
                    <button class="form-btn" data-form="ir_external">IR - External Works</button>
                    <button class="form-btn" data-form="mir">Material Inspection Request (MIR)</button>
                    <button class="form-btn" data-form="mit">Material Inspection Transmittal</button>
                    <button class="form-btn" data-form="csor">Construction Site Observation</button>
                    <button class="form-btn" data-form="concrete_casting_report">Concrete Casting Report</button>
                    <button class="form-btn" data-form="weekly_progress_report">Weekly Progress Report</button>
                    <button class="form-btn" data-form="weekly_progress_plan">Weekly Progress Plan</button>
                    <button class="form-btn" data-form="mom">Minutes of Meeting</button>
                    <button class="form-btn" data-form="mom_attendees">Meeting Attendees</button>
                    <button class="form-btn" data-form="non_conformance_notice">Non-Conformance Notice (NCN)</button>
                    <button class="form-btn" data-form="ncn_log">NCN Log</button>
                    <button class="form-btn" data-form="nominated_subcontractor_log">Nominated Subcontractor Log</button>
                    <button class="form-btn" data-form="variation_order_request">Variation Order Request</button>
                    <button class="form-btn" data-form="variation_order_register">Variation Order Register</button>
                    <button class="form-btn" data-form="snag_list">Snag List</button>
                    <button class="form-btn" data-form="prehandover_landscaping">Pre-Handover: Landscaping</button>
                    <button class="form-btn" data-form="prehandover_envelope">Pre-Handover: Envelope</button>
                    <button class="form-btn" data-form="prehandover_fitout">Pre-Handover: Fit Out</button>
                    <button class="form-btn" data-form="ehs_office_checklist">EHS Office Checklist</button>
                    <button class="form-btn" data-form="emergency_drill_record">Emergency Drill Record</button>
                    <button class="form-btn" data-form="incident_notification">Incident Notification</button>
                    <button class="form-btn" data-form="incident_investigation_report">Incident Investigation</button>
                    <button class="form-btn" data-form="safety_improvement_report">Safety Improvement Report</button>
                    <button class="form-btn" data-form="monthly_hse_report">Monthly HSE Report</button>
                    <button class="form-btn" data-form="svr">Safety Violation Report (SVR)</button>
                    <button class="form-btn" data-form="site_safety_tour">Site Safety Tour</button>
                    <button class="form-btn" data-form="contractor_project_commencement_deliverables">Commencement Deliverables</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- MODALS -->
<div id="mom-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="width: 90%; max-width: 1200px;">
        <span id="mom-modal-close-btn" class="modal-close-btn">×</span>
        <h2 id="mom-modal-title">Minutes of Meeting</h2>
        <div class="modal-body">
            <input type="hidden" id="mom-edit-index">
            <div class="input-group-grid" style="grid-template-columns: 1fr 1fr 1fr 1fr; gap: 15px;">
                <div class="input-group"><label>MoM Ref. No.</label><input type="text" id="mom-ref"></div>
                <div class="input-group"><label>Meeting Date</label><input type="date" id="mom-date"></div>
                <div class="input-group"><label>Location</label><input type="text" id="mom-location"></div>
                <div class="input-group"><label>Current Progress (%)</label><input type="number" id="mom-progress" min="0" max="100"></div>
            </div>
            <h4>Attendees <button id="add-attendee-btn" class="secondary-button small-button">+ Add</button></h4>
            <table class="mom-table"><thead><tr><th style="width: 35%;">Name</th><th style="width: 30%;">Position</th><th style="width: 30%;">Company</th><th>Del</th></tr></thead><tbody id="mom-attendees-tbody"></tbody></table>
            <div class="input-row-container">
                <div class="input-group" style="flex: 1;"><label>Project Status Summary</label><textarea id="mom-status-summary" rows="5"></textarea></div>
                <div class="input-group" style="flex: 1;"><label>2-Week Look Ahead</label><textarea id="mom-lookahead" rows="3"></textarea><label style="margin-top: 10px; display:block;">Required Materials</label><textarea id="mom-materials" rows="2"></textarea></div>
            </div>
            <h4>Action Items <button id="add-action-btn" class="secondary-button small-button">+ Add</button></h4>
            <table class="mom-table"><thead><tr><th style="width: 45%;">Description</th><th style="width: 15%;">Action By</th><th style="width: 15%;">Target Date</th><th style="width: 20%;">Status</th><th>Del</th></tr></thead><tbody id="mom-actions-tbody"></tbody></table>
            <h4>Next Meeting</h4>
            <div class="input-group-grid" style="grid-template-columns: 1fr 2fr; gap: 15px;">
                <div class="input-group"><label>Next Meeting Date</label><input type="datetime-local" id="mom-next-meeting"></div>
                <div class="input-group"><label>Confirmation Notes</label><input type="text" id="mom-next-meeting-notes"></div>
            </div>
        </div>
        <div class="modal-footer">
             <button id="delete-mom-btn" class="danger-button" style="display: none; float: left;">Delete MoM</button>
             <button id="save-mom-data-btn" class="primary-button">Save MoM</button>
        </div>
    </div>
</div>

<div id="mom-preview-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="width: 90%; max-width: 950px;">
        <span id="mom-preview-modal-close-btn" class="modal-close-btn">×</span>
        <h2 id="mom-preview-modal-title">MoM Preview</h2>
        <div id="mom-preview-modal-body" class="modal-body"></div>
        <div id="mom-preview-modal-footer" class="modal-footer"></div>
    </div>
</div>
<div id="rfi-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="width: 90%; max-width: 900px;">
        <span id="rfi-modal-close-btn" class="modal-close-btn">×</span>
        <h2 id="rfi-modal-title">Raise New Request for Information (RFI)</h2>
        <div class="modal-body">
            <input type="hidden" id="rfi-edit-id">
            <div class="input-group-grid" style="grid-template-columns: 1fr 2fr;">
                <div class="input-group"><label>RFI Ref No.</label><input type="text" id="rfi-ref-no" readonly></div>
                <div class="input-group"><label>Subject</label><input type="text" id="rfi-subject"></div>
            </div>
            <div class="input-group"><label>Detailed Question / Description</label><textarea id="rfi-description" rows="4"></textarea></div>
            
            <div class="rfi-attachments-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div>
                    <h4>Attach New Files</h4>
                    <input type="file" id="rfi-file-attach" multiple>
                    <ul id="rfi-new-attachments-list" style="list-style: none; padding: 5px; margin: 5px 0; max-height: 150px; overflow-y: auto; background: #f9f9f9; border: 1px solid #ddd;"></ul>
                </div>
                <div>
                    <h4>Link Existing Project Documents</h4>
                    <select id="rfi-doc-link-select" multiple size="5" style="width:100%;"></select>
                </div>
            </div>
            
            <div class="input-group">
                <h4>Required Approvals</h4>
                <div class="checkbox-group" id="rfi-approvers-group">
                    <label><input type="checkbox" name="rfiApprover" value="Arch"> Architectural</label>
                    <label><input type="checkbox" name="rfiApprover" value="STR"> Structural</label>
                    <label><input type="checkbox" name="rfiApprover" value="MEP"> MEP</label>
                    <label><input type="checkbox" name="rfiApprover" value="Site Eng"> Site Engineer</label>
                </div>
            </div>
            <hr>
            <div class="input-group">
                <h4>Response & Comments</h4>
                <textarea id="rfi-response-comments" rows="4" placeholder="This section will be filled by the responding party."></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button id="save-rfi-btn" class="primary-button">Save RFI</button>
        </div>
    </div>
</div>

<div id="form-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="width: 90%; max-width: 950px;">
        <span id="form-modal-close-btn" class="modal-close-btn">×</span>
        <h2 id="form-modal-title">Form</h2>
        <div id="form-modal-body" class="modal-body"></div>
       <div class="modal-footer">
             <button id="print-form-btn" class="secondary-button">Print as PDF</button>
             <button id="save-form-btn" class="primary-button">Save</button>
        </div>
    </div>
</div>

<div id="new-task-modal" class="modal-overlay" style="display: none;"></div>

<div id="subcontractor-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="width: 90%; max-width: 800px;">
        <span id="subcontractor-modal-close-btn" class="modal-close-btn">×</span>
        <h2 id="subcontractor-modal-title">Add/Edit Subcontractor</h2>
        <div class="modal-body">
            <input type="hidden" id="subcontractor-edit-id">
            <div class="input-group"><label>Company Name*</label><input type="text" id="sub-company"></div>
            <div class="input-group"><label>Trade*</label><input type="text" id="sub-trade" placeholder="e.g., MEP, Joinery, Tiling"></div>
            <hr>
           <div class="info-module-grid">
                <div class="input-group"><label>Contact Person</label><input type="text" id="sub-contact-person"></div>
                <div class="input-group"><label>Mobile</label><input type="tel" id="sub-mobile"></div>
                <div class="input-group"><label>Phone 1</label><input type="tel" id="sub-phone1"></div>
                <div class="input-group"><label>Phone 2</label><input type="tel" id="sub-phone2"></div>
                <div class="input-group"><label>Email 1</label><input type="email" id="sub-email1"></div>
                <div class="input-group"><label>Email 2</label><input type="email" id="sub-email2"></div>
                <div class="input-group"><label>Fax</label><input type="text" id="sub-fax"></div>
                <div class="input-group"><label>Website</label><input type="url" id="sub-website"></div>
            </div>
              <div class="input-group"><label>Location Map URL</label><input type="url" id="sub-map"></div>
            <div class="input-group"><label>Address</label><textarea id="sub-address" rows="2"></textarea></div>
            <hr>
            <div class="input-group">
                <label>Upload Quotation/Prequalification</label>
                <input type="file" id="sub-quotation-file">
                <div id="sub-existing-file" style="margin-top: 5px;"></div>
            </div>
            <div class="info-module-grid">
                 <div>
                    <label>Logo 1</label><input type="file" id="sub-logo1-input" accept="image/*">
                    <div class="logo-preview-container"><img id="sub-logo1-preview" src="" class="logo-preview" alt="Logo 1 Preview"></div>
                </div>
                <div>
                    <label>Logo 2</label><input type="file" id="sub-logo2-input" accept="image/*">
                    <div class="logo-preview-container"><img id="sub-logo2-preview" src="" class="logo-preview" alt="Logo 2 Preview"></div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
             <button id="delete-subcontractor-btn" class="danger-button" style="display: none; float: left;">Delete</button>
             <button id="save-subcontractor-btn" class="primary-button">Save Subcontractor</button>
        </div>
    </div>
</div>

<!-- Generic Report Modal -->
<div id="report-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="width: 90%; max-width: 1200px;">
        <span id="report-modal-close-btn" class="modal-close-btn">×</span>
        <h2 id="report-modal-title">Report Preview</h2>
        <div id="report-modal-body" class="modal-body"></div>
        <div id="report-modal-footer" class="modal-footer">
             <button id="print-report-btn" class="primary-button" style="display: none;">Print as PDF</button>
        </div>
    </div>
</div>
<div id="file-preview-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <span id="file-preview-close-btn" class="modal-close-btn">×</span>
        <h2 id="file-preview-title">File Preview</h2>
        <div class="modal-body">
            <img id="file-preview-image" src="" alt="Image Preview" style="display: none;">
            <iframe id="file-preview-embed" src="" style="display: none;"></iframe>
            <p id="file-preview-info">This file type cannot be previewed directly.</p>
        </div>
        <div class="modal-footer">
            <a id="file-download-btn" class="primary-button" href="#" download>Download File</a>
        </div>
    </div>
</div>
<!-- NEW MODALS -->
<div id="snag-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="width: 90%; max-width: 800px;">
        <span id="snag-modal-close-btn" class="modal-close-btn">×</span>
        <h2 id="snag-modal-title">New Snag Item</h2>
        <div class="modal-body">
            <input type="hidden" id="snag-edit-id">
            <div class="input-group-grid" style="grid-template-columns: 1fr 1fr;">
                <div class="input-group"><label>Item/Location</label><input type="text" id="snag-item"></div>
                <div class="input-group"><label>Date Spotted</label><input type="date" id="snag-date-spotted"></div>
            </div>
            <div class="input-group"><label>Description of Snag</label><textarea id="snag-description" rows="3"></textarea></div>
            <div class="input-group"><label>Photo of Snag</label><input type="file" id="snag-photo-issue" accept="image/*"></div>
            <hr>
            <div class="input-group-grid" style="grid-template-columns: 1fr 1fr 1fr;">
                <div class="input-group"><label>Criticality</label><select id="snag-criticality"><option>Low</option><option>Medium</option><option>High</option></select></div>
                <div class="input-group"><label>Spotted By</label><input type="text" id="snag-by-whom"></div>
                <div class="input-group"><label>Rectification Method</label><input type="text" id="snag-method"></div>
            </div>
            <hr>
            <h4>Resolution</h4>
            <div class="input-group-grid" style="grid-template-columns: 1fr 1fr;">
                <div class="input-group"><label>Date Resolved</label><input type="date" id="snag-date-resolved"></div>
                <div class="input-group"><label>Resolved By (Engineer)</label><input type="text" id="snag-by-eng"></div>
            </div>
            <div class="input-group"><label>Photo of Resolution</label><input type="file" id="snag-photo-resolved" accept="image/*"></div>
        </div>
        <div class="modal-footer"><button id="save-snag-btn" class="primary-button">Save Snag</button></div>
    </div>
</div>

<div id="payment-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="width: 90%; max-width: 700px;">
        <span id="payment-modal-close-btn" class="modal-close-btn">×</span>
        <h2 id="payment-modal-title">Track New Payment</h2>
        <div class="modal-body">
            <input type="hidden" id="payment-edit-id">
            <div class="input-group"><label>Description</label><input type="text" id="payment-description"></div>
            <div class="input-group-grid" style="grid-template-columns: 1fr 1fr;">
                <div class="input-group"><label>To Whom</label><select id="payment-to-whom"><option>Consultant</option><option>Contractor</option><option>Subcontractor</option><option>Supplier</option><option>Authority</option><option>General</option></select></div>
                <div class="input-group"><label>Amount (AED)</label><input type="number" id="payment-amount"></div>
            </div>
            <div class="input-group-grid" style="grid-template-columns: 1fr 1fr 1fr;">
                <div class="input-group"><label>Payment Mode</label><select id="payment-mode"><option>Cheque</option><option>Bank Transfer</option><option>Cash</option></select></div>
                <div class="input-group"><label>Cheque/Ref No.</label><input type="text" id="payment-ref-no"></div>
                <div class="input-group"><label>Payment Date</label><input type="date" id="payment-date"></div>
            </div>
            <div class="input-group"><label>Upload Receipt/Tax Invoice</label><input type="file" id="payment-receipt-file"></div>
            <hr>
            <h4>Follow-up</h4>
            <div class="input-group-grid" style="grid-template-columns: 1fr 1fr;">
                <div class="input-group"><label>Chase By</label><input type="text" id="payment-chase-by"></div>
                <div class="input-group"><label>Next Chase Date</label><input type="date" id="payment-chase-date"></div>
            </div>
        </div>
        <div class="modal-footer"><button id="save-payment-btn" class="primary-button">Save Payment</button></div>
    </div>
</div>

<div id="inventory-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="width: 90%; max-width: 700px;">
        <span id="inventory-modal-close-btn" class="modal-close-btn">×</span>
        <h2 id="inventory-modal-title">New Inventory/Warranty Item</h2>
        <div class="modal-body">
            <input type="hidden" id="inventory-edit-id">
            <div class="input-group"><label>Item Name / Appliance</label><input type="text" id="inventory-item"></div>
            <div class="input-group"><label>Type/Model</label><input type="text" id="inventory-type"></div>
            <div class="input-group"><label>Photo</label><input type="file" id="inventory-photo" accept="image/*"></div>
            <div class="input-group"><label>Description/Notes</label><textarea id="inventory-description" rows="2"></textarea></div>
            <hr>
            <h4>Supplier / Contact</h4>
            <div class="input-group-grid" style="grid-template-columns: 1fr 1fr;">
                 <div class="input-group"><label>Supplier Name</label><input type="text" id="inventory-supplier"></div>
                 <div class="input-group"><label>Contact Person</label><input type="text" id="inventory-contact-person"></div>
            </div>
             <div class="input-group-grid" style="grid-template-columns: 1fr 1fr;">
                 <div class="input-group"><label>Contact Phone</label><input type="tel" id="inventory-contact-phone"></div>
                 <div class="input-group"><label>Contact Email</label><input type="email" id="inventory-contact-email"></div>
            </div>
            <hr>
            <h4>Warranty Period</h4>
            <div class="input-group-grid" style="grid-template-columns: 1fr 1fr;">
                <div class="input-group"><label>Warranty Start</label><input type="date" id="inventory-date-start"></div>
                <div class="input-group"><label>Warranty End</label><input type="date" id="inventory-date-end"></div>
            </div>
        </div>
        <div class="modal-footer"><button id="save-inventory-btn" class="primary-button">Save Item</button></div>
    </div>
</div>
<input type="file" id="project-file-input" accept=".xml,text/xml" style="display:none;">

<!-- JS LIBRARIES -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="js/logo_base64.js"></script>
<script src="js/constants.js"></script>
<script src="js/vendor_list.js"></script>
<script src="js/quotes.js"></script>
<script src="js/xml_handler.js"></script>
<script src="js/database.js"></script>
<script src="js/pdf_generator.js"></script>
<script src="js/gantt_chart.js"></script>
<script src="js/bim_viewer.js"></script>
<!-- NEW MODULES -->
<script type="module" src="js/site_modules/client_info_module.js"></script>
<script type="module" src="js/site_modules/contractor_info_module.js"></script>
<!-- MAIN APP LOGIC -->
<script type="module" src="js/site_index.js"></script>

</body>
</html>