<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF-Based Construction Schedule & BIM Simulation</title>
    
    <!-- Three.js Dependencies -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

    <style>
        body { margin: 0; padding: 20px; font-family: 'Segoe UI', sans-serif; background: #f8f9fa; color: #333; }
        .container { max-width: 1600px; margin: 0 auto; background: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); overflow: hidden; }
        
        header { background: #2c3e50; color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
        h1 { margin: 0; font-size: 1.2rem; }
        .subtitle { font-size: 0.8rem; opacity: 0.8; margin-top: 4px; }

        /* Controls */
        .controls-area { background: #ecf0f1; padding: 15px; display: flex; align-items: center; gap: 15px; border-bottom: 1px solid #ddd; }
        button { background: #27ae60; color: white; border: none; padding: 8px 20px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 0.9rem; transition: 0.2s; }
        button:hover { background: #219150; }
        input[type=range] { flex-grow: 1; cursor: pointer; }
        .date-display { background: white; padding: 5px 15px; border-radius: 4px; font-weight: bold; min-width: 120px; text-align: center; border: 1px solid #ccc; }

        /* Layout */
        .view-split { display: flex; height: 750px; }
        
        /* Gantt Chart */
        .gantt-pane { flex: 1; border-right: 1px solid #ddd; overflow-y: auto; padding: 10px; background: #fff; }
        .gantt-header { display: grid; grid-template-columns: 200px 1fr; font-weight: bold; padding-bottom: 5px; border-bottom: 2px solid #eee; margin-bottom: 10px; font-size: 0.9rem;}
        
        .task-row { display: grid; grid-template-columns: 200px 1fr; align-items: center; margin-bottom: 6px; font-size: 11px; height: 22px; }
        .task-name { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding-right: 10px; border-right: 1px solid #eee; margin-right: 5px; color: #444; }
        .task-timeline-area { position: relative; height: 100%; background: #f9f9f9; border-radius: 2px; }
        
        .gantt-bar { 
            position: absolute; height: 16px; top: 3px; border-radius: 3px; 
            font-size: 9px; color: white; display: flex; align-items: center; padding-left: 5px; overflow: hidden;
            transition: width 0.1s, left 0.1s;
        }
        
        /* Task Status Colors */
        .bar-planned { background: #bdc3c7; }
        .bar-active { background: #f39c12; box-shadow: 0 0 5px rgba(243, 156, 18, 0.6); z-index: 5; border: 1px solid #d35400; }
        .bar-completed { background: #2ecc71; }

        /* BIM View */
        .bim-pane { flex: 1.2; background: #222; position: relative; }
        #bim-canvas { width: 100%; height: 100%; }
        
        .legend { position: absolute; bottom: 15px; left: 15px; background: rgba(0,0,0,0.8); color: white; padding: 12px; border-radius: 6px; font-size: 0.8rem; pointer-events: none; }
        .legend-item { display: flex; align-items: center; margin-bottom: 6px; }
        .color-box { width: 14px; height: 14px; margin-right: 10px; border: 1px solid #555; border-radius: 2px; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div>
            <h1>Construction Schedule - Residential (Villa # 0585/1)</h1>
            <div class="subtitle">South Dharan Home Ownership Projects | Data Source: PDF Schedule</div>
        </div>
    </header>
    
    <div class="controls-area">
        <button id="btn-play">▶ Play Simulation</button>
        <input type="range" id="slider-sim" min="0" max="100" value="0">
        <div id="display-date" class="date-display">-</div>
    </div>

    <div class="view-split">
        <div class="gantt-pane" id="container-gantt">
            <div class="gantt-header"><div>Activity Name</div><div>Timeline</div></div>
            <!-- Tasks injected via JS -->
        </div>
        <div class="bim-pane" id="container-bim">
            <div class="legend">
                <div class="legend-item"><div class="color-box" style="background: rgba(200,200,200,0.1); border: 1px dashed #666;"></div> Pending</div>
                <div class="legend-item"><div class="color-box" style="background: #f39c12;"></div> In Progress</div>
                <div class="legend-item"><div class="color-box" style="background: #7f8c8d;"></div> Concrete Structure</div>
                <div class="legend-item"><div class="color-box" style="background: #c0392b;"></div> Block Work</div>
                <div class="legend-item"><div class="color-box" style="background: #ecf0f1;"></div> Plaster / Paint</div>
            </div>
        </div>
    </div>
</div>

<script>

// --- 1. DATA FROM PDF (Villa # 0585/1) ---
// Start Date in PDF: 01-Jun-16. We simulate this as Day 0.
// Durations are taken directly from "Original Duration" column.
// Start offsets calculated based on dependencies implied in PDF.

const PDF_TASKS = [
    // Sub Structure
    { id: 'earth_work', name: 'Earth work for foundation', start: 0, dur: 12, type: 'ground' },
    { id: 'ug_utility', name: 'U/G utility for Mech/Elect', start: 20, dur: 4, type: 'ground' }, // Starts after Earth Work + lag
    { id: 'foundation', name: 'Foundation + Waterproofing', start: 28, dur: 13, type: 'concrete' },
    { id: 'backfill', name: 'Backfilling & Compaction', start: 49, dur: 3, type: 'ground' },
    
    // Super Structure
    { id: 'gf_col', name: 'Ground floor columns', start: 49, dur: 10, type: 'concrete' },
    { id: 'ff_slab', name: 'First floor slab', start: 61, dur: 17, type: 'concrete' },
    { id: 'ff_col', name: 'First floor columns', start: 81, dur: 10, type: 'concrete' },
    { id: 'rf_slab', name: 'Roof floor slab', start: 92, dur: 17, type: 'concrete' },
    { id: 'ur_col', name: 'Upper roof columns & slab', start: 117, dur: 15, type: 'concrete' },

    // All Floors (Finishes)
    { id: 'block', name: 'Block work', start: 141, dur: 25, type: 'block' },
    { id: 'elec_fix', name: 'Fix electrical conduits', start: 171, dur: 6, type: 'mep' },
    { id: 'hvac_drain', name: 'Install HVAC drain system', start: 171, dur: 4, type: 'mep' },
    { id: 'int_plast', name: 'Internal plaster', start: 178, dur: 30, type: 'finish' },
    { id: 'floor_skirt', name: 'Internal flooring & skirting', start: 213, dur: 12, type: 'finish' },
    { id: 'gypsum', name: 'Fix gypsum false ceiling', start: 221, dur: 4, type: 'finish' },
    { id: 'stairs', name: 'Tread and riser for stairs', start: 226, dur: 4, type: 'finish' },
    { id: 'paint_1', name: 'Painting putty & first coat', start: 226, dur: 15, type: 'paint' },
    { id: 'handrail', name: 'Fix handrails to stairs', start: 230, dur: 2, type: 'finish' },
    { id: 'windows', name: 'Install windows', start: 243, dur: 6, type: 'glass' },
    { id: 'elec_wire', name: 'Pulling electrical wires', start: 243, dur: 2, type: 'mep' },
    { id: 'doors', name: 'Install doors', start: 248, dur: 6, type: 'finish' },
    { id: 'paint_2', name: 'Painting second coat', start: 248, dur: 8, type: 'paint' },
    { id: 'elec_term', name: 'Circuit breakers termination', start: 257, dur: 2, type: 'mep' },
    { id: 'hvac_unit', name: 'Fix HVAC split units', start: 257, dur: 2, type: 'mep' },
    { id: 'elec_acc', name: 'Install wiring accessories', start: 259, dur: 6, type: 'mep' },
    { id: 'fire_alarm', name: 'Fix fire alarm / intercom', start: 266, dur: 13, type: 'mep' },
    { id: 'final_paint', name: 'Final painting & cleaning', start: 283, dur: 14, type: 'paint' },

    // Toilet and Kitchen
    { id: 'plumb_conduit', name: 'Fix electric conduits wet area', start: 178, dur: 2, type: 'mep' },
    { id: 'water_pipe', name: 'Fix water pipes', start: 213, dur: 3, type: 'mep' },
    { id: 'sewage', name: 'Sewage work over waterproofing', start: 213, dur: 3, type: 'mep' },
    { id: 'wet_ceil', name: 'Fix services above wet ceiling', start: 216, dur: 2, type: 'mep' },
    { id: 'waterproof', name: 'Waterproofing wet area', start: 218, dur: 3, type: 'finish' },
    { id: 'tiles_wet', name: 'Tiles to wet areas', start: 222, dur: 3, type: 'finish' },
    { id: 'ceil_wet', name: 'Install false ceiling wet areas', start: 223, dur: 2, type: 'finish' },
    { id: 'wire_wet', name: 'Install wiring/lighting wet area', start: 225, dur: 2, type: 'mep' },
    { id: 'kitchen_cab', name: 'Install service kitchen cabinets', start: 251, dur: 2, type: 'finish' },
    
    // External Work (Page 2)
    { id: 'ext_found', name: 'External boundary wall found.', start: 135, dur: 4, type: 'concrete' },
    { id: 'ext_col', name: 'Boundary wall RC column', start: 140, dur: 6, type: 'concrete' },
    { id: 'ext_block', name: 'Boundary wall block work', start: 147, dur: 14, type: 'block' },
    { id: 'ext_finish', name: 'External Finishes (Villa)', start: 202, dur: 22, type: 'paint' },
    { id: 'paving', name: 'Paving tiles', start: 236, dur: 5, type: 'finish' },
    
    // Commissioning
    { id: 'testing', name: 'Testing & Commissioning', start: 283, dur: 20, type: 'mep' }
];

// --- 2. SIMULATION ENGINE ---

const SimEngine = (() => {
    let startDate = new Date("2016-06-01"); // From PDF "01-Jun-16"
    let totalDays = 318; // From PDF "SUB-ZONE # 01" duration
    
    const getTasks = () => PDF_TASKS.map(t => {
        const dStart = new Date(startDate); dStart.setDate(dStart.getDate() + t.start);
        const dEnd = new Date(dStart); dEnd.setDate(dEnd.getDate() + t.dur);
        return { ...t, dateStart: dStart, dateEnd: dEnd };
    });

    const renderGantt = (tasks, currentDate) => {
        const container = document.getElementById('container-gantt');
        container.innerHTML = '<div class="gantt-header"><div>Activity Name</div><div>Timeline</div></div>';
        
        const projectStartMs = startDate.getTime();
        const projectTotalMs = totalDays * 24 * 60 * 60 * 1000;
        const currentMs = currentDate.getTime();

        tasks.forEach(task => {
            const taskStartMs = task.dateStart.getTime();
            const taskEndMs = task.dateEnd.getTime();
            
            // Status logic
            let statusClass = 'bar-planned';
            let progressW = 0;

            if (currentMs >= taskEndMs) {
                statusClass = 'bar-completed';
                progressW = 100;
            } else if (currentMs >= taskStartMs) {
                statusClass = 'bar-active';
                progressW = ((currentMs - taskStartMs) / (taskEndMs - taskStartMs)) * 100;
            }

            const leftPos = ((taskStartMs - projectStartMs) / projectTotalMs) * 100;
            const width = ((taskEndMs - taskStartMs) / projectTotalMs) * 100;

            if(width > 0) {
                const row = document.createElement('div');
                row.className = 'task-row';
                row.innerHTML = `
                    <div class="task-name" title="${task.name}">${task.name}</div>
                    <div class="task-timeline-area">
                        <div class="gantt-bar ${statusClass}" style="left: ${leftPos}%; width: ${width}%;">
                            <div style="width:${progressW}%; background:rgba(255,255,255,0.3); height:100%; position:absolute;"></div>
                        </div>
                    </div>
                `;
                container.appendChild(row);
            }
        });
    };

    return { getTasks, totalDays, startDate, renderGantt };
})();

// --- 3. 3D VISUALIZER (THREE.JS) ---

const Visualizer = (() => {
    let scene, camera, renderer, controls;
    let meshes = {}; // map task.id -> array of THREE.Mesh

    // Materials Library
    const MATS = {
        ghost: new THREE.MeshBasicMaterial({ color: 0xdddddd, wireframe: true, opacity: 0.05, transparent: true }),
        active: new THREE.MeshLambertMaterial({ color: 0xf39c12, transparent: true, opacity: 0.8 }),
        concrete: new THREE.MeshLambertMaterial({ color: 0x95a5a6 }),
        block: new THREE.MeshLambertMaterial({ color: 0xc0392b }),
        plaster: new THREE.MeshLambertMaterial({ color: 0xecf0f1 }),
        paint: new THREE.MeshLambertMaterial({ color: 0xffffff }),
        glass: new THREE.MeshPhongMaterial({ color: 0x3498db, opacity: 0.6, transparent: true }),
        ground: new THREE.MeshLambertMaterial({ color: 0x8d6e63 }),
        mep: new THREE.MeshStandardMaterial({ color: 0x2980b9, metalness: 0.5 })
    };

    const init = () => {
        const container = document.getElementById('container-bim');
        const w = container.clientWidth;
        const h = container.clientHeight;

        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x222222);

        // Camera
        camera = new THREE.PerspectiveCamera(45, w/h, 0.1, 1000);
        camera.position.set(40, 30, 40);

        // Renderer
        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(w, h);
        renderer.shadowMap.enabled = true;
        container.appendChild(renderer.domElement);

        // Lights
        const hemiLight = new THREE.HemisphereLight(0xffffff, 0x444444, 0.6);
        scene.add(hemiLight);
        const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
        dirLight.position.set(20, 50, 20);
        dirLight.castShadow = true;
        scene.add(dirLight);

        // Controls
        controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.target.set(0, 5, 0);
        controls.update();

        // Grid
        scene.add(new THREE.GridHelper(60, 60, 0x555555, 0x333333));

        buildModel();
        animate();
    };

    const animate = () => {
        requestAnimationFrame(animate);
        controls.update();
        renderer.render(scene, camera);
    };

    const addPart = (taskId, geo, x, y, z, sx=1, sy=1, sz=1) => {
        const mesh = new THREE.Mesh(geo, MATS.ghost.clone());
        mesh.position.set(x, y, z);
        mesh.scale.set(sx, sy, sz);
        mesh.castShadow = true;
        mesh.receiveShadow = true;
        scene.add(mesh);

        if(!meshes[taskId]) meshes[taskId] = [];
        meshes[taskId].push(mesh);
    };

    const buildModel = () => {
        // 1. Earth Work (Visualized as ground pit)
        addPart('earth_work', new THREE.BoxGeometry(20, 0.5, 20), 0, -0.5, 0);
        
        // 2. Foundation
        const foundGeo = new THREE.BoxGeometry(15, 0.8, 15);
        addPart('foundation', foundGeo, 0, 0.4, 0);

        // 3. Columns (GF)
        const colGeo = new THREE.BoxGeometry(0.6, 3.5, 0.6);
        // 4 corners + mid points
        [[-6,-6], [6,-6], [-6,6], [6,6]].forEach(pos => {
            addPart('gf_col', colGeo, pos[0], 2.5, pos[1]);
        });

        // 4. FF Slab
        const slabGeo = new THREE.BoxGeometry(16, 0.4, 16);
        addPart('ff_slab', slabGeo, 0, 4.4, 0);

        // 5. Columns (FF)
        [[-6,-6], [6,-6], [-6,6], [6,6]].forEach(pos => {
            addPart('ff_col', colGeo, pos[0], 6.3, pos[1]);
        });

        // 6. Roof Slab
        addPart('rf_slab', slabGeo, 0, 8.2, 0);

        // 7. Upper Roof Columns & Slab (Stair tower)
        addPart('ur_col', new THREE.BoxGeometry(4, 3, 6), 0, 9.9, 0);

        // 8. Block Work (Walls) - Outer shell
        // GF Walls
        addPart('block', new THREE.BoxGeometry(14, 3.5, 0.2), 0, 2.5, 7); // Front
        addPart('block', new THREE.BoxGeometry(14, 3.5, 0.2), 0, 2.5, -7); // Back
        addPart('block', new THREE.BoxGeometry(0.2, 3.5, 14), 7, 2.5, 0); // Right
        addPart('block', new THREE.BoxGeometry(0.2, 3.5, 14), -7, 2.5, 0); // Left
        
        // FF Walls
        addPart('block', new THREE.BoxGeometry(14, 3.5, 0.2), 0, 6.3, 7); 
        addPart('block', new THREE.BoxGeometry(14, 3.5, 0.2), 0, 6.3, -7); 
        addPart('block', new THREE.BoxGeometry(0.2, 3.5, 14), 7, 6.3, 0); 
        addPart('block', new THREE.BoxGeometry(0.2, 3.5, 14), -7, 6.3, 0); 

        // 9. Windows
        const winGeo = new THREE.BoxGeometry(2, 1.5, 0.4);
        addPart('windows', winGeo, 3, 2.5, 7);
        addPart('windows', winGeo, -3, 2.5, 7);
        addPart('windows', winGeo, 3, 6.3, 7);

        // 10. Plaster (Visual layer) -> Re-colors block work really, but adding thin layer
        // We will handle this by material swapping on the 'block' meshes if simple, 
        // or add specific plaster meshes. For this demo, we add internal partitions.
        addPart('int_plast', new THREE.BoxGeometry(0.2, 3.5, 10), 0, 2.5, 0); // Internal Wall GF
        addPart('int_plast', new THREE.BoxGeometry(10, 3.5, 0.2), 0, 6.3, 0); // Internal Wall FF

        // 11. Paint / Finishes
        // Represented by roof waterproofing layer
        addPart('waterproof', new THREE.BoxGeometry(16.2, 0.1, 16.2), 0, 8.45, 0);
        
        // 12. External Boundary Wall
        const boundGeo = new THREE.BoxGeometry(30, 2, 0.2);
        addPart('ext_block', boundGeo, 0, 1, 14);
        addPart('ext_block', boundGeo, 0, 1, -14);
        const boundGeoSide = new THREE.BoxGeometry(0.2, 2, 28);
        addPart('ext_block', boundGeoSide, 14, 1, 0);
        addPart('ext_block', boundGeoSide, -14, 1, 0);
    };

    const update = (tasks, currentDate) => {
        const curMs = currentDate.getTime();

        tasks.forEach(task => {
            const meshList = meshes[task.id];
            if(!meshList) return;

            const startMs = task.dateStart.getTime();
            const endMs = task.dateEnd.getTime();

            let mat = MATS.ghost;
            let opacity = 0.05;
            let isVisible = true;

            if (curMs >= endMs) {
                // Completed
                switch(task.type) {
                    case 'concrete': mat = MATS.concrete; break;
                    case 'block': mat = MATS.block; break;
                    case 'paint': mat = MATS.paint; break;
                    case 'glass': mat = MATS.glass; break;
                    case 'ground': mat = MATS.ground; break;
                    case 'finish': mat = MATS.plaster; break;
                    case 'mep': mat = MATS.mep; break;
                    default: mat = MATS.concrete;
                }
                opacity = 1.0;
                if(task.type === 'glass') opacity = 0.6;
            } else if (curMs >= startMs) {
                // Active
                mat = MATS.active;
                opacity = 0.8;
            } else {
                // Pending
                mat = MATS.ghost;
                opacity = 0.05;
            }

            meshList.forEach(m => {
                // Optimize material swap
                if(m.material.uuid !== mat.uuid) {
                    m.material = mat.clone(); // Clone to allow opacity tweens if needed
                    m.material.opacity = opacity;
                    m.material.transparent = (opacity < 1);
                }
            });
        });
    };

    return { init, update };
})();

// --- 4. APP LOGIC ---
const App = (() => {
    let interval = null;
    const slider = document.getElementById('slider-sim');
    const dateDiv = document.getElementById('display-date');
    const playBtn = document.getElementById('btn-play');
    
    const start = () => {
        // 1. Setup Data
        const tasks = SimEngine.getTasks();
        const startDate = SimEngine.startDate;
        const maxDays = SimEngine.totalDays;
        
        slider.max = maxDays;
        
        // 2. Setup BIM
        Visualizer.init();

        // 3. Update Loop
        const updateState = () => {
            const dayOffset = parseInt(slider.value);
            const currDate = new Date(startDate);
            currDate.setDate(currDate.getDate() + dayOffset);
            
            dateDiv.textContent = currDate.toDateString();
            
            SimEngine.renderGantt(tasks, currDate);
            Visualizer.update(tasks, currDate);
        };

        // 4. Controls
        slider.addEventListener('input', updateState);
        
        playBtn.addEventListener('click', () => {
            if(interval) {
                clearInterval(interval);
                interval = null;
                playBtn.textContent = "▶ Play Simulation";
            } else {
                playBtn.textContent = "⏸ Pause";
                interval = setInterval(() => {
                    let val = parseInt(slider.value);
                    if(val >= maxDays) {
                        clearInterval(interval);
                        interval = null;
                        playBtn.textContent = "▶ Play Simulation";
                    } else {
                        slider.value = val + 1;
                        updateState();
                    }
                }, 50); // 50ms per day
            }
        });

        // Initial call
        updateState();
    };

    return { start };
})();

document.addEventListener('DOMContentLoaded', App.start);

</script>
</body>
</html>